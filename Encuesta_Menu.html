<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Satisfacción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilos para los botones de opción (Radio Buttons personalizados) */
        .option-btn {
            border: 1px solid #e5e7eb;
            background-color: white;
            transition: all 0.2s;
        }
        .option-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .option-btn.selected {
            background-color: #3b82f6; /* Azul */
            color: white;
            border-color: #3b82f6;
            font-weight: 600;
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- PANTALLA DE ENCUESTA CERRADA (Por defecto oculta) -->
    <div id="closed-screen" class="hidden text-center w-full max-w-md bg-white p-8 rounded-3xl shadow-xl">
        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-gray-100 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Encuesta no disponible</h2>
        <p class="text-gray-500">La encuesta de satisfacción está cerrada en este momento. Por favor, inténtalo más tarde.</p>
    </div>

    <!-- CONTENEDOR PRINCIPAL (Se muestra solo si la encuesta está abierta) -->
    <div id="main-container" class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl w-full max-w-2xl border border-gray-100 my-8 hidden">
        <!-- HEADER -->
        <div class="text-center mb-8 border-b pb-4 relative">
            <img src="https://downloads.puertocoatzacoalcos.com.mx/imagenes/LOGOASPN.png" alt="Logo" class="h-16 mx-auto mb-4 object-contain">
            <h1 class="text-2xl font-bold text-gray-800">Encuesta de Satisfacción</h1>
            <p class="text-gray-500 text-sm mt-1">Tu opinión nos ayuda a seguir mejorando.</p>
        </div>

        <!-- PASO 1: LOGIN -->
        <div id="login-step" class="animate-fade-in">
            <label class="block text-gray-700 text-sm font-bold mb-2">Ingresa tu Número de Empleado</label>
            <div class="relative">
                <input type="text" id="employee-id" class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Ej. 12345">
            </div>
            <button id="btn-validate" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-md hover:shadow-lg transform active:scale-95">
                Comenzar Encuesta
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-3 hidden text-center bg-red-50 p-2 rounded-lg"></p>
        </div>

        <!-- PASO 2: ENCUESTA -->
        <div id="survey-step" class="hidden animate-fade-in">
            <!-- Info del Usuario -->
            <div class="bg-blue-50 p-4 rounded-xl mb-6 flex items-center justify-between sticky top-0 z-10 shadow-sm border border-blue-100">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-blue-600 font-bold uppercase tracking-wide">Empleado</p>
                        <p id="user-name" class="font-bold text-gray-800 text-lg leading-tight line-clamp-1"></p>
                    </div>
                </div>
                <!-- Botón de Salir / Cerrar Sesión -->
                <button id="btn-close-session" class="text-gray-500 hover:text-red-600 transition p-2 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-red-50 flex items-center gap-2 text-xs font-bold" title="Cancelar y Salir">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    SALIR
                </button>
            </div>
            
            <form id="survey-form" class="space-y-8">
                
                <!-- SECCIÓN 1: ALIMENTOS -->
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-2">1</span> Evaluación de los Alimentos
                    </h2>
                    <div id="section-1-questions" class="space-y-6">
                        <!-- Las preguntas se generan con JS -->
                    </div>
                </div>

                <!-- SECCIÓN 2: COMEDOR Y SERVICIO -->
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-2">2</span> Evaluación del Comedor y Servicio
                    </h2>
                    <div id="section-2-questions" class="space-y-6">
                        <!-- Las preguntas se generan con JS -->
                    </div>
                </div>

                <!-- SECCIÓN 3: OPINIÓN GENERAL -->
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-2">3</span> Opinión General y Sugerencias
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">3.1 ¿Qué fue lo que más te gustó?</label>
                            <textarea id="q3-1" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Escribe aquí..."></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">3.2 ¿Qué aspectos consideras que se deben mejorar?</label>
                            <textarea id="q3-2" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Escribe aquí..."></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">3.3 ¿Hay algún platillo que te gustaría ver en el menú?</label>
                            <textarea id="q3-3" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Escribe aquí..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Checkbox Anónimo -->
                <div class="flex items-center bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <input id="anon-check" type="checkbox" class="w-5 h-5 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                    <label for="anon-check" class="ml-3 text-sm font-medium text-gray-700 cursor-pointer select-none">
                        Enviar como <b>Anónimo</b> <br><span class="text-xs text-gray-500 font-normal">Tu nombre no aparecerá en las respuesta de la encuesta.</span>
                    </label>
                </div>

                <button type="button" id="btn-submit" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 transition shadow-lg hover:shadow-xl transform active:scale-95 text-lg">
                    Enviar Encuesta
                </button>
            </form>
        </div>

        <!-- PASO 3: ÉXITO -->
        <div id="success-step" class="hidden text-center animate-fade-in py-8">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
                <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">¡Gracias por participar!</h2>
            <p class="text-gray-600 mb-8">Tus respuestas han sido registradas correctamente.</p>
            <button onclick="window.location.reload()" class="text-blue-600 font-semibold hover:text-blue-800 hover:underline transition">
                Volver al inicio
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
              apiKey: "AIzaSyBRl9cy-k0MfXOz3-StMr497YwCLQT8il0",
              authDomain: "ceunico.firebaseapp.com",
              databaseURL: "https://ceunico.firebaseio.com",
              projectId: "ceunico",
              storageBucket: "ceunico.firebasestorage.app",
              messagingSenderId: "750486055882",
              appId: "1:750486055882:web:f270aa8cbddcbcd0d37d33"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserData = null;

        signInAnonymously(auth).catch((error) => console.error("Error Auth:", error));

        // --- CONTROL DE ACCESO (ENCUESTA ABIERTA/CERRADA) ---
        onSnapshot(doc(db, "settings", "app-settings"), (docSnap) => {
            const isSurveyOpen = docSnap.exists() && docSnap.data().isSurveyOpen;
            const mainContainer = document.getElementById('main-container');
            const closedScreen = document.getElementById('closed-screen');

            if (isSurveyOpen) {
                mainContainer.classList.remove('hidden');
                closedScreen.classList.add('hidden');
            } else {
                mainContainer.classList.add('hidden');
                closedScreen.classList.remove('hidden');
            }
        });

        // --- CONFIGURACIÓN DE PREGUNTAS ---
        const options = ["Malo", "Regular", "Bueno", "Superó mis expectativas", "Otros"];
        
        const section1 = [
            { id: "1.1", text: "1.1 Sabor de los alimentos" },
            { id: "1.2", text: "1.2 Variedad del menú ofrecido" },
            { id: "1.3", text: "1.3 Presentación de los platillos" },
            { id: "1.4", text: "1.4 Cantidad / Porciones servidas" },
            { id: "1.5", text: "1.5 Temperatura adecuada de los alimentos" },
            { id: "1.6", text: "1.6 Frescura y calidad de los ingredientes" }
        ];

        const section2 = [
            { id: "2.1", text: "2.1 Limpieza y orden del comedor" },
            { id: "2.2", text: "2.2 Comodidad del espacio (mesas, sillas)" },
            { id: "2.3", text: "2.3 Amabilidad del personal" },
            { id: "2.4", text: "2.4 Rapidez en el servicio" }
        ];

        // Estado de las respuestas
        const answers = {};

        // Función para generar HTML de preguntas
        function renderQuestions(questions, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = questions.map(q => `
                <div class="pb-2">
                    <label class="block text-gray-800 font-medium mb-3 text-sm sm:text-base">${q.text}</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${options.map(opt => `
                            <button type="button" 
                                class="option-btn py-2 px-3 rounded-lg text-sm text-gray-600 text-left w-full flex items-center"
                                onclick="selectOption('${q.id}', '${opt}', this)">
                                <div class="w-4 h-4 border rounded-full mr-2 flex-shrink-0 border-gray-400 circle-indicator"></div>
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    <!-- Input oculto para 'Otros' -->
                    <input type="text" id="other-${q.id}" class="hidden mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500" placeholder="Especifique otro...">
                </div>
            `).join('');
        }

        // Renderizar al cargar (aunque el div esté oculto)
        renderQuestions(section1, "section-1-questions");
        renderQuestions(section2, "section-2-questions");

        // Hacer la función global para el onclick en HTML
        window.selectOption = (questionId, value, btnElement) => {
            // 1. Guardar valor base
            answers[questionId] = { value: value, otherText: "" };
            
            // 2. Actualizar UI (Estilos de botones)
            const parentDiv = btnElement.parentElement;
            const buttons = parentDiv.querySelectorAll('.option-btn');
            buttons.forEach(b => {
                b.classList.remove('selected');
                b.querySelector('.circle-indicator').classList.remove('bg-white', 'border-transparent');
                b.querySelector('.circle-indicator').classList.add('border-gray-400');
            });
            
            btnElement.classList.add('selected');
            const indicator = btnElement.querySelector('.circle-indicator');
            indicator.classList.remove('border-gray-400');
            indicator.classList.add('bg-white', 'border-transparent'); // Círculo blanco relleno

            // 3. Manejar campo "Otros"
            const otherInput = document.getElementById(`other-${questionId}`);
            if (value === "Otros") {
                otherInput.classList.remove('hidden');
                otherInput.focus();
                // Listener para capturar el texto de otros
                otherInput.oninput = (e) => {
                    answers[questionId].otherText = e.target.value;
                };
            } else {
                otherInput.classList.add('hidden');
                otherInput.value = "";
            }
        };

        // --- LÓGICA DE LOGIN Y ENVÍO ---

        // Función de validación encapsulada para usar en Click y Enter
        const performLogin = async () => {
            const empId = document.getElementById('employee-id').value.trim();
            const errorMsg = document.getElementById('login-error');
            const btn = document.getElementById('btn-validate');
            
            if (!empId) {
                errorMsg.textContent = "Por favor ingresa tu número.";
                errorMsg.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mx-auto"></div>';
            errorMsg.classList.add('hidden');

            try {
                const docRef = doc(db, 'employees', empId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentUserData = { id: empId, ...docSnap.data() };
                    document.getElementById('user-name').textContent = currentUserData.name;
                    document.getElementById('login-step').classList.add('hidden');
                    document.getElementById('survey-step').classList.remove('hidden');
                    window.scrollTo(0,0);
                } else {
                    errorMsg.textContent = "Número de empleado no encontrado.";
                    errorMsg.classList.remove('hidden');
                    btn.textContent = "Intentar de nuevo";
                }
            } catch (e) {
                console.error(e);
                errorMsg.textContent = "Error de conexión. Verifica tu internet.";
                errorMsg.classList.remove('hidden');
                btn.textContent = "Intentar de nuevo";
            } finally {
                if (btn.textContent !== "Intentar de nuevo") btn.disabled = false;
            }
        };

        // Event Listeners para Login
        document.getElementById('btn-validate').addEventListener('click', performLogin);
        
        document.getElementById('employee-id').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Evita el submit por defecto del formulario si lo hubiera
                performLogin();
            }
        });

        // FUNCIONALIDAD DEL BOTÓN CERRAR / SALIR
        document.getElementById('btn-close-session').addEventListener('click', () => {
            // Reiniciar la página es la forma más limpia de resetear todos los estados
            window.location.reload();
        });

        document.getElementById('btn-submit').addEventListener('click', async () => {
            // Validar que todas las preguntas obligatorias tengan respuesta
            const allQuestions = [...section1, ...section2];
            const missing = allQuestions.find(q => !answers[q.id]);
            
            if (missing) {
                alert(`Falta responder: ${missing.text}`);
                return;
            }

            // Validar "Otros" vacíos
            for (const key in answers) {
                if (answers[key].value === "Otros" && !answers[key].otherText.trim()) {
                    alert("Por favor especifique el detalle en la opción 'Otros'.");
                    return;
                }
            }

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.textContent = "Enviando...";

            try {
                // Recopilar respuestas de texto
                const textResponses = {
                    "3.1 Gusto": document.getElementById('q3-1').value.trim(),
                    "3.2 Mejora": document.getElementById('q3-2').value.trim(),
                    "3.3 Sugerencia Menu": document.getElementById('q3-3').value.trim()
                };

                const isAnonymous = document.getElementById('anon-check').checked;

                // Construir objeto final
                const flatAnswers = {};
                for (const key in answers) {
                    if (answers[key].value === "Otros") {
                        flatAnswers[key] = `Otros: ${answers[key].otherText}`;
                    } else {
                        flatAnswers[key] = answers[key].value;
                    }
                }

                const surveyData = {
                    ...flatAnswers,
                    ...textResponses,
                    timestamp: serverTimestamp(),
                    isAnonymous: isAnonymous,
                    // Campos Públicos (para que se vea "Anónimo" en reportes generales)
                    employeeId: isAnonymous ? "ANON" : currentUserData.id,
                    employeeName: isAnonymous ? "Anónimo" : currentUserData.name,
                    // Campos Ocultos (para que el Admin sepa quién fue)
                    realEmployeeId: currentUserData.id,
                    realEmployeeName: currentUserData.name
                };

                await addDoc(collection(db, 'surveys_v2'), surveyData);

                document.getElementById('survey-step').classList.add('hidden');
                document.getElementById('success-step').classList.remove('hidden');
                window.scrollTo(0,0);
            } catch (e) {
                console.error(e);
                alert("Error al enviar la encuesta. Intenta de nuevo.");
                btn.disabled = false;
                btn.textContent = "Enviar Encuesta";
            }
        });
    </script>
</body>
</html>
